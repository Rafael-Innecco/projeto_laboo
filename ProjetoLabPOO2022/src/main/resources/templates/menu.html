<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title> Menu Principal </title>
	
		<link rel="stylesheet" href="./menu.css">
	</head>
	
	<body onload="busca()">
		<div class="nav-bar-container">
			<h2 id="projeto-text">Projetão LabOO - 2022</h2>
			<button class="logout-button">
				<p>Sair</p> 
				<img class="logout-img" src="./logout_icon.png" alt="Sair">
			</button>
		</div>
		<h1 class="title-header">Super Gerenciador Musical</h1>
		
	    <!-- busca musica -->
		<div class="search-form-container">
			<form>
				<p id="search-tag">Pesquisar</p>
				<input class="caixaBusca" type="text" th:name="nome-busca" id="nome-busca-input" value="Digite um item para buscar..."> 
				<input class="botao1 animated1" id="unico" type="submit" value="Buscar"/>
			</form>
		</div>
		
		<div class="section-container">
			<h2 class="title-h2">Minhas playlists</h2>
			<p class="text-p">Clique para ver as playlists que você criou.</p>
			<div id="lista-de-playlists"></div>
		</div>

		<!-- Lista Playlists -->
		<form>
            <button class="botao1 animated2" id="unico" type="button" onclick="listaPlaylists('semBotão'); scrolldiv('lista-de-playlists')">Listar Playlists</button>
		</form>


		
	   <!-- cria Playslist -->
		<form th:action="@{/menu/cria-playlist}">
			<div class="playlist-buttons-container">
				<input class="botao2" id="create-playlist-button" type="submit" value="+ Criar nova playlist"/>
				<button id="remove-playlist-button">Remover playlist</button>
			</div>
		</form>

		<!-- Template de um botão "REMOVE" -->
		<!-- <div class="section-container">
			<p>Template de um botão: </p>

			<button class="remove-button">
				⨉ Remover
			</button>

		</div> -->

		<div class="section-container">
			<h2 class="title-h2">Resultados de busca</h2>
			<p class="text-p">Clique em uma música para ver detalhes ou adicionar a uma playlist.</p>
			
			<div id="resultadosDeBusca">
			</div>
		</div>
		
		<div class="section-container">
			<h2 class="title-h2">Músicas da playlist</h2>
			<div id="itens-de-playlist"></div>
		</div>
		
		<!-- Popup para adicionar música a uma Playlist -->
		<div class="form-popup" id="popupAdicionarMusica">
         	<form class="form-container">
           			<h1>Adicionar esta música à playlist</h1>
	       		<select id="dropdownPlaylists">
						 <option value="none" selected disabled hidden>Selecione uma playlist</option>
					 </select>
					 
           		<button type="button" class="btn" onclick="selecionarPlaylistParaAdicionar()">Adicionar</button>
           		<button type="button" class="btn cancel" onclick="fechaForm()">Sair</button>
         	</form>
        </div>
		
		<script>
			function selecionarPlaylistParaAdicionar(){					
				let select = document.getElementById('dropdownPlaylists');
				let idDaPlaylist = select.value;
				let uriDaMusica = window.localStorage.getItem('uriDaMusica');

				console.log("URI da música que será adicionada: " + uriDaMusica);
				console.log("ID da playlist: " + idDaPlaylist);

				adicionaMusica(uriDaMusica, idDaPlaylist);
				console.log("Adicionei a música: " + uriDaMusica);
			}

			function getQueryVariable(variable) {
			       let query = window.location.search.substring(1);
			       let vars = query.split("&");
			       for (let i=0;i<vars.length;i++) {
							let pair = vars[i].split("=");
							if(pair[0] == variable){return pair[1];}
			       }
			       return(false);
			}
			
			function busca() {
				let queryParam = getQueryVariable("nome-busca");
				if (queryParam == false)
					return;
				console.log("buscando...");
				fetch('/menu/busca-musica?nome-busca=' + getQueryVariable("nome-busca"))
					.then(function (response) {
						return response.json();
					})
					.then(function (data) {
						appendData_busca(data, "resultadosDeBusca");
					})
					.catch(function (err) {
						console.log('error: ' + err);
					});
			}
			
			function appendData_busca(data, elementId) {
				let mainContainer = document.getElementById(elementId);

				// Esvazia o conteúdo inicial da div
				mainContainer.innerHTML = "";

				for (let i = 0; i < data.length; i++) {
					
					let h4 = document.createElement("h4");
					let div = document.createElement('div');
					let button_listar = document.createElement('button');
					
					h4.innerHTML = 'Nome: ' + data[i].name + ' — Artista: ' + data[i].artists[0].name;
					
					button_listar.setAttribute('class', 'open-button');
					button_listar.type = 'button';
					button_listar.setAttribute('onclick', 'abreForm("'+data[i].id+'");listaPlaylists();');

					button_listar.innerHTML = '+ Adicionar a uma Playlist';

					div.appendChild(h4);
					div.appendChild(button_listar);
					mainContainer.appendChild(div);

					console.log('Name: ' + data[i].name + ' ;');
					console.log('Id: ' + data[i].id + ' ;');
				}
			}
			
			function abreForm(uriDaMusica) {
				document.getElementById("popupAdicionarMusica").style.display = "block";

				// Salva a uri da música para ser usada no botão "Adicionar"
				window.localStorage.setItem('uriDaMusica', uriDaMusica);
				console.log("URI no localStorage: " + window.localStorage.getItem('uriDaMusica'));
			}

			function fechaForm() {
				document.getElementById("popupAdicionarMusica").style.display = "none";
			}
			
			function listaPlaylists(uriDaMusica) {
				console.log("buscando...");
				fetch('/menu/lista-playlists?')
					.then(function (response) {
						return response.json();
					})
					.then(function (data) {
						appendData_playlist(data, uriDaMusica);
					})
					.catch(function (err) {
						console.log('error: ' + err);
					});
			}
			
			function appendData_playlist(data, uriDaMusica) {
				let mainContainer = document.getElementById("lista-de-playlists");

				mainContainer.innerHTML = "";
				let dropdownDePlaylists = document.getElementById("dropdownPlaylists");
				
				for (let i = 0; i < data.length; i++) {
					// Cria o elemento <option> para cada playlist, para mostrar no dropdown de escolhas
					dropdownDePlaylists.innerHTML += `<option value= "${data[i].id}">` + data[i].name + "</option>";

					let div = document.createElement('div');
					div.id = "playlist-numero-" + i;

					let h4 = document.createElement('h4');
					let button_remover = document.createElement('button');
					let button_listar = document.createElement('button');

					h4.innerHTML = 'Name: ' + data[i].name + ' ;';
					
					button_remover.setAttribute('class', 'botao2');
					button_remover.type = 'button';
					button_remover.setAttribute('onclick', 'deletaPlaylist("' + data[i].id + '", "' + div.id + '")');
					button_remover.innerHTML = 'Remover';
					
					button_listar.setAttribute('class', 'botao2');
					button_listar.type = 'button';
					button_listar.setAttribute('onclick', 'listaItens("' + data[i].id + '")');
					button_listar.innerHTML = 'Listar músicas';

					div.appendChild(h4);
					div.appendChild(button_remover);
					div.appendChild(button_listar);
					
					console.log('Name: ' + data[i].name + ' ;');
					console.log('Id: ' + data[i].id + ' ;');
					mainContainer.appendChild(div);
				}
			}

			function deletaPlaylist(idDaPlaylist, idDaDiv) {
				console.log(idDaPlaylist);
				fetch('/menu/remove-playlist?playlist-selecionada=' + idDaPlaylist)
					.then(function (response) {
						console.log("Playlist removida?");
						console.log(response);
						return response.json();
					})
					.then(function (data) {
						let div = document.getElementById(idDaDiv);
						div.remove();
					})
					.catch(function (err) {
						console.log('erro ao remover playlist: ' + err);
					});
			}
			
			function listaItens(idDaPlaylist) {
				console.log("Playlist listada: " + idDaPlaylist);
				fetch('/menu/lista-itens-de-playlist?playlist-selecionada=' + idDaPlaylist)
					.then(function (response) {
						return response.json();
					})
					.then(function (data) {
						appendData_itens(data, "itens-de-playlist", idDaPlaylist);
					})
					.catch(function (err) {
						console.log("Erro ao listar playlist: " + err);
					}); 
			}

			function appendData_itens(data, elementId, idDaPlaylist) {
				let mainContainer = document.getElementById(elementId);
				mainContainer.innerHTML = "";

				for (let i = 0; i < data.length; i++) {
					let card = `<div id="item-playlist-${i}"><h4>Nome: ${data[i].track.name} — Artista: ${data[i].track.artists[0].name}</h4><button class="botao2" onclick="removeMusica("${data[i].track.uri}", "${idDaPlaylist}", "item-playlist-${i}")">Remover da playlist</button></div>`;

					mainContainer.innerHTML += card;
				}
			}
			
			function removeMusica (uriDaMusica, idDaPlaylist, idDaDiv){
				console.log(idDaPlaylist);
				fetch('/menu/remove-itens-de-playlist?playlist-selecionada=' + idDaPlaylist + '&uris=' + uriDaMusica)
					.then(function (response) {
						console.log("Música removida?");
						console.log(response);
						return response.json();
					})
					.then(function (data) {
						console.log("Música removida!");
						let div = document.getElementById(idDaDiv);
						div.remove();
					})
					.catch(function (err) {
						console.log('erro ao remover playlist: ' + err);
					});
			}
			
			
			// TODO
			function adicionaMusica (uriDaMusica, idDaPlaylist){
				console.log("ID da playlist para add a música: " + idDaPlaylist);

				fetch('/menu/adiciona-itens?playlist-selecionada=' + idDaPlaylist + '&uri=spotify:track:' + uriDaMusica)
					.then(function (response) {
						console.log("Musica adicionada?");
						console.log(response);
						return response.json();
					})
					.then(function (data) {
						console.log("Música adicionada!");
						alert("Música adicionada com sucesso!");
					})
					.catch(function (err) {
						console.log('Erro ao adicionar playlist: ' + err);
					});
			}

			function scrolldiv(idDaDiv) {
				let elem = document.getElementById(idDaDiv);
				elem.scrollIntoView();
			}
		</script>
	</body>
</html>
