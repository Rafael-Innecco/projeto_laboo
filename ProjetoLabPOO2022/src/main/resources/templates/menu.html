<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title> Menu Principal </title>
	
		<style>
		    body{
              background-color:#28272c;	
              color: yellow;
			  font-family: "Courier New";
			  font-size: 14px;		  
			}
			
			.caixaBusca{
			  padding: 20px;
              text-align: center;
              display: inline-block;
			  font-family: "Courier New";	
              font-size: 14px;
			  display: block;
			  margin-top: 180px;
              margin-left: auto;
              margin-right: auto;
			  width: 50%;
              cursor: pointer;
			  border-radius: 26px;
			  background-color: #28272c;
			  border: 1px solid MediumSeaGreen;
			  color: MediumSeaGreen;
			}
			   
			.botao1{
              padding: 18px;
              text-align: center;
              display: inline-block;
			  font-family: "Courier New";	
              font-size: 20px;
              cursor: pointer;
			  border-radius: 8px;
			  transition-duration: 0.4s;
			  display: block;
			  margin-top: 10px;
			  margin-left: auto;
              margin-right: auto;
			  
			}
			
			.animated1{
			  background-color: #28272c;
              color: MediumSeaGreen;
			  border: 1px solid MediumSeaGreen;
			}
			
			.animated1:hover{
			  background-color: MediumSeaGreen;
              color: #28272c;
			}	
			
			.animated2{
			  background-color: #28272c;
              color: Tomato;
			  border: 1px solid Tomato;
			}
			
			.animated2:hover{
			  background-color: Tomato;
              color: #28272c;
			}	
			.botao2{
              padding: 10px;
              text-align: center;
              display: inline-block;
			  font-family: "Courier New";	
              font-size: 13px;
              margin: 2px 1px;
              cursor: pointer;
			  border-radius: 26px;
			  background-color: Tomato;
			  color: #28272c;			  
			}	
			
		</style>
	</head>
	
	<body onload="busca()">
	    <!-- busca musica -->
		<form>
			<input class="caixaBusca" type="text" th:name="nome-busca" id="nome-busca-input" value="Digite um item para buscar..."> 
			<input class="botao1 animated1" type="submit" value="Buscar"/>
		</form>
		
		<!-- Lista Playlists -->
		<form>
            <button class="botao1 animated2" type="button" onclick="listaPlaylists('semBotão'); scrolldiv('lista-de-playlists')">Listar Playlists</button>
		</form>
		
	    <!-- cria Playslist -->
		<form th:action="@{/menu/cria-playlist}">
			<input type="text" th:name="nome-da-playlist" value="Nome Playlist..."> 
			<input class="botao2" type="submit" value="criar"/>
		</form>

		<div id="resultadosDeBusca">
            <br>
			<h2>Musicas Buscadas:</h2> <br>
		</div>
		
		<p>---------------------------------</p>
		<h2>Musicas da Playlist:</h2><br>
		<div id="itens-de-playlist"></div>

		<p>---------------------------------</p>
		<h2>Playlists:</h2> <br>
		<div id="lista-de-playlists"></div>
		
		<script>
			function getQueryVariable(variable)
			{
			       var query = window.location.search.substring(1);
			       var vars = query.split("&");
			       for (var i=0;i<vars.length;i++) {
			               var pair = vars[i].split("=");
			               if(pair[0] == variable){return pair[1];}
			       }
			       return(false);
			}
			
			function busca(){
				var queryParam = getQueryVariable("nome-busca");
				if (queryParam == false)
					return;
				console.log("buscando...");
				fetch('/menu/busca-musica?nome-busca=' + getQueryVariable("nome-busca"))
					.then(function (response) {
						console.log('Primeiro then');
						return response.json();
					})
					.then(function (data) {
						console.log('Segundo then');
						appendData_busca(data, "resultadosDeBusca");
					})
					.catch(function (err) {
						console.log('Terceiro then');
						console.log('error: ' + err);
					});
			}
			
			function appendData_busca(data, elementId) {
				var mainContainer = document.getElementById(elementId);

				// Esvazia o conteúdo inicial da div
				mainContainer.innerHTML = "";

				for (var i = 0; i < data.length; i++) {
					var h4 = document.createElement("h4");
					var div = document.createElement('div');
					var button_listar = document.createElement('button');
					
					h4.innerHTML = 'Name: ' + data[i].name + ' ; Artist: ' + data[i].artists[0].name;
					
					button_listar.setAttribute('class', 'botao2');
					button_listar.type = 'button';
					button_listar.setAttribute('onclick', 'listaPlaylists("' + data[i].uri + '"); scrolldiv("lista-de-playlists")');
					button_listar.innerHTML = 'adicionar a uma Playlist';
					
					div.appendChild(h4);
					div.appendChild(button_listar);
					
					console.log('Name: ' + data[i].name + ' ;');
					console.log('Id: ' + data[i].id + ' ;');
					mainContainer.appendChild(div);
				}
			}
			
			function listaPlaylists(uriDaMusica){
				console.log("buscando...");
				fetch('/menu/lista-playlists?')
					.then(function (response) {
						return response.json();
					})
					.then(function (data) {
						appendData_playlist(data, uriDaMusica);
					})
					.catch(function (err) {
						console.log('error: ' + err);
					});
			}
			
			function appendData_playlist(data, uriDaMusica) {
				var mainContainer = document.getElementById("lista-de-playlists");

				/*while (mainContainer.firstChild){
					div.removeChild(div.firstChild);
				}*/

				mainContainer.innerHTML = "";
				
				for (var i = 0; i < data.length; i++) {
					var div = document.createElement('div');
					div.id = "playlist-numero-" + i;

					var h4 = document.createElement('h4');
					var button_remover = document.createElement('button');
					var button_listar = document.createElement('button');
					var button_adicionar = document.createElement('button');

					h4.innerHTML = 'Name: ' + data[i].name + ' ;';
					
					button_remover.setAttribute('class', 'botao2');
					button_remover.type = 'button';
					button_remover.setAttribute('onclick', 'deletaPlaylist("' + data[i].id + '", "' + div.id + '")');
					button_remover.innerHTML = 'Remover';
					
					button_listar.setAttribute('class', 'botao2');
					button_listar.type = 'button';
					button_listar.setAttribute('onclick', 'listaItens("' + data[i].id + '")');
					button_listar.innerHTML = 'Listar músicas';

					div.appendChild(h4);
					div.appendChild(button_remover);
					div.appendChild(button_listar);

					if(uriDaMusica != 'semBotão')
					{
						button_adicionar.setAttribute('class', 'botao2');
						button_adicionar.type = 'button';
						button_adicionar.setAttribute('onclick', 'adicionaMusica("' + uriDaMusica + '", "' + data[i].id + '")');
						button_adicionar.innerHTML = 'Adicionar música';
						div.appendChild(button_adicionar);
					}
					
					console.log('Name: ' + data[i].name + ' ;');
					console.log('Id: ' + data[i].id + ' ;');
					mainContainer.appendChild(div);
				}
			}

			function deletaPlaylist(idDaPlaylist, idDaDiv) {
				console.log(idDaPlaylist);
				fetch('/menu/remove-playlist?playlist-selecionada=' + idDaPlaylist)
					.then(function (response) {
						console.log("Playlist removida?");
						console.log(response);
						return response.json();
					})
					.then(function (data) {
						var div = document.getElementById(idDaDiv);
						div.remove();
					})
					.catch(function (err) {
						console.log('erro ao remover playlist: ' + err);
					});
			}
			
			function listaItens(idDaPlaylist) {
				console.log("Playlist listada: " + idDaPlaylist);
				fetch('/menu/lista-itens-de-playlist?playlist-selecionada=' + idDaPlaylist)
					.then(function (response) {
						return response.json();
					})
					.then(function (data) {
						appendData_itens(data, "itens-de-playlist", idDaPlaylist);
					})
					.catch(function (err) {
						console.log("Erro ao listar playlist: " + err);
					}); 
			}
			
			function appendData_itens(data, elementId, idDaPlaylist) {
				var mainContainer = document.getElementById(elementId);

				mainContainer.innerHTML = "";

				for (var i = 0; i < data.length; i++) {
					var div = document.createElement("div");
					div.id = "item-playlist-" + i;

					var h4 = document.createElement("h4");
					var button_remove = document.createElement("button");
					
					button_remove.setAttribute('class', 'botao2');
					button_remove.type = 'button';
					button_remove.setAttribute('onclick', 'removeMusica("' + data[i].track.uri + '", "' + idDaPlaylist + '", "' + div.id +  '")');
					button_remove.innerHTML = 'Remover da playlist';
					
					h4.innerHTML = 'Name: ' + data[i].track.name + ' ; Artist: ' + data[i].track.artists[0].name;

					div.appendChild(h4);
					div.appendChild(button_remove);

					mainContainer.appendChild(div);
				}
			}
			
			function removeMusica (uriDaMusica, idDaPlaylist, idDaDiv){
				console.log(idDaPlaylist);
				fetch('/menu/remove-itens-de-playlist?playlist-selecionada=' + idDaPlaylist + '&uris=' + uriDaMusica)
					.then(function (response) {
						console.log("Música removida?");
						console.log(response);
						return response.json();
					})
					.then(function (data) {
						console.log("Música removida!");
						var div = document.getElementById(idDaDiv);
						div.remove();
					})
					.catch(function (err) {
						console.log('erro ao remover playlist: ' + err);
					});
			}
			
			
			function adicionaMusica (uriDaMusica, idDaPlaylist){
				console.log(idDaPlaylist);
				fetch('/menu/adiciona-itens?playlist-selecionada=' + idDaPlaylist + '&uri=' + uriDaMusica)
					.then(function (response) {
						console.log("Musica adicionada?");
						alert("Música adicionada com sucesso!");
						console.log(response);
						return response.json();
					})
					.then(function (data) {
						console.log("Música adicionada!");
					})
					.catch(function (err) {
						console.log('erro ao adicionar playlist: ' + err);
					});
			}

			function scrolldiv(idDaDiv) {
                var elem = document.getElementById(idDaDiv);
                elem.scrollIntoView();
            }
		</script>
	</body>
</html>
